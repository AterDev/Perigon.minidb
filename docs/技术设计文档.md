# ğŸ“„ å¾®å‹å†…å­˜æ•°æ®åº“å¼•æ“æŠ€æœ¯è®¾è®¡æ–‡æ¡£ï¼ˆMiniDBï¼‰

## 1. é¡¹ç›®æ¦‚è¿°
æœ¬é¡¹ç›®ç›®æ ‡æ˜¯å®ç°ä¸€ä¸ªè½»é‡çº§ã€å•æ–‡ä»¶ã€å…³ç³»å‹å†…å­˜æ•°æ®åº“å¼•æ“ï¼Œä¸“ç”¨äºå°æ•°æ®é‡ï¼ˆâ‰¤50MBæ–‡ä»¶ï¼‰ã€‚
ç‰¹ç‚¹ï¼š
- å…¨å†…å­˜åŠ è½½ï¼šå¯åŠ¨æ—¶ä¸€æ¬¡æ€§å°†æ•°æ®æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼ŒæŸ¥è¯¢å’Œä¿®æ”¹åŸºäºå†…å­˜å¯¹è±¡é›†åˆã€‚
- å¢é‡æŒä¹…åŒ–å†™å…¥ï¼šä¿®æ”¹æˆ–åˆ é™¤æ•°æ®åï¼Œåªå°†å˜æ›´éƒ¨åˆ†æ›´æ–°åˆ°æ–‡ä»¶ï¼Œè€Œä¸æ˜¯å…¨é‡å†™å…¥ã€‚
- å¤šçº¿ç¨‹å®‰å…¨è¯»å–ï¼šå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶è¯»å–å†…å­˜é›†åˆã€‚
- å•çº¿ç¨‹æ–‡ä»¶å†™å…¥ï¼šæ‰€æœ‰æ–‡ä»¶æ›´æ–°ç”±ä¸“ç”¨çº¿ç¨‹æ‰§è¡Œï¼Œé¿å…ç£ç›˜å†™å†²çªã€‚
- ç®€åŒ–åŠŸèƒ½ï¼šæ— å¤–é”®ã€æ— ç´¢å¼•ã€æ— å¤æ‚æ•°æ®çº¦æŸã€‚
- API ç±»ä¼¼ EF Coreï¼Œä½†ä¸ä¾èµ– EF Coreã€‚
- é‡‡ç”¨å›ºå®šé•¿åº¦äºŒè¿›åˆ¶æ ¼å¼å­˜å‚¨ï¼Œæ”¯æŒçœŸæ­£çš„å¢é‡æ›´æ–°ï¼ˆO(1)å¯»å€ï¼‰ã€‚
- åºåˆ—åŒ–å°è£…åœ¨å†…éƒ¨ï¼Œç”¨æˆ·æ— éœ€ä¸ºå®ä½“ç±»æ·»åŠ ä»»ä½•åºåˆ—åŒ–ç‰¹æ€§ã€‚

é€‚ç”¨åœºæ™¯ï¼š
- å°å‹æ¡Œé¢åº”ç”¨ã€æœ¬åœ°å·¥å…·å­˜å‚¨ã€åµŒå…¥å¼è„šæœ¬é…ç½®ã€‚
- æ•°æ®é‡ä¸è¶…è¿‡åä¸‡è®°å½•ï¼Œæ–‡ä»¶ä½“ç§¯ â‰¤ 50MBã€‚

---

## 2. æŠ€æœ¯ç›®æ ‡

### 2.1 æ”¯æŒåŠŸèƒ½
- å•æ–‡ä»¶æœ¬åœ°å­˜å‚¨
- å…¨é‡å†…å­˜åŠ è½½ï¼ˆâ‰¤50MBï¼‰
- å¢é‡æ–‡ä»¶æ›´æ–°ï¼ˆä¿®æ”¹/åˆ é™¤æ—¶ä»…æ›´æ–°å¯¹åº”è®°å½•ï¼‰
- å¤šçº¿ç¨‹åŒæ—¶è¯»å–
- å•çº¿ç¨‹æŒä¹…åŒ–å†™å…¥ï¼ˆæ–‡ä»¶æ›´æ–°ä¸²è¡ŒåŒ–ï¼‰
- ç±»å‹å®‰å…¨å®ä½“æ¨¡å‹ï¼ˆæ— åºåˆ—åŒ–æ³¨è§£æš´éœ²ç»™ç”¨æˆ·ï¼‰
- æä¾›ç±»ä¼¼ EF Core çš„ DbContext çš„æŠ½è±¡å±‚ï¼Œæ”¯æŒ LINQ æŸ¥è¯¢

âŒ ä¸æ”¯æŒï¼š
- å¤–é”®å…³ç³»
- å¤æ‚ç´¢å¼•ä¸çº¦æŸ
- SQL è§£æå™¨
- å­˜å‚¨è¿‡ç¨‹ / è§¦å‘å™¨ / è§†å›¾
- æ•°æ®åº“å†…äº‹åŠ¡éš”ç¦»ï¼ˆç”± SaveChanges æ›¿ä»£ï¼‰

---

## 3. æ¶æ„è®¾è®¡

### 3.1 é«˜å±‚æ¶æ„
```
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åº”ç”¨å±‚ï¼ˆç”¨æˆ·ä»£ç ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 MicroDbContext (ç”¨æˆ·è‡ªå®šä¹‰æ´¾ç”Ÿç±»)
 DbSet<TEntity> (è¡¨é›†åˆï¼ŒLINQ æŸ¥è¯¢)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 å¼•æ“æ ¸å¿ƒ
  â€¢ ChangeTrackerï¼ˆå¢é‡å˜æ›´è®°å½•ï¼‰
  â€¢ StorageManagerï¼ˆæ–‡ä»¶è¯»/å†™ï¼Œå¢é‡æ›´æ–°ï¼‰
  â€¢ ThreadSafetyManagerï¼ˆè¯»å†™é”ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 åº•å±‚æ”¯æŒ
  â€¢ å›ºå®šé•¿åº¦äºŒè¿›åˆ¶ç¼–è§£ç ï¼ˆå†…éƒ¨ï¼‰
  â€¢ æ–‡ä»¶IOï¼ˆå•çº¿ç¨‹æ›´æ–°ï¼‰
  â€¢ å†…å­˜é›†åˆï¼ˆList<TEntity>ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

## 4. è¯¦ç»†éœ€æ±‚è®¾è®¡

### 4.1 æ•°æ®å­˜å‚¨æ¨¡å‹

#### æ–‡ä»¶ç»“æ„ï¼ˆå›ºå®šé•¿åº¦äºŒè¿›åˆ¶æ ¼å¼ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–‡ä»¶å¤´ (256å­—èŠ‚ï¼Œå›ºå®šé•¿åº¦)                           â”‚
â”‚ - é­”æ³•æ•°: "MDB1" (4å­—èŠ‚)                             â”‚
â”‚ - ç‰ˆæœ¬å·: 1 (2å­—èŠ‚)                                  â”‚
â”‚ - è¡¨æ•°é‡: N (2å­—èŠ‚)                                  â”‚
â”‚ - ä¿ç•™: (248å­—èŠ‚ï¼Œç”¨äºæ‰©å±•)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¡¨å…ƒæ•°æ®åŒº (æ¯è¡¨128å­—èŠ‚ï¼ŒNÃ—128å­—èŠ‚)                 â”‚
â”‚ æ¯ä¸ªè¡¨é¡¹:                                            â”‚
â”‚ - è¡¨å: "Users" (64å­—èŠ‚ï¼Œå›ºå®šé•¿åº¦)                  â”‚
â”‚ - è®°å½•æ•°: (4å­—èŠ‚)                                    â”‚
â”‚ - è®°å½•å¤§å°: 128 (4å­—èŠ‚ï¼Œå›ºå®šé•¿åº¦)                    â”‚
â”‚ - æ•°æ®èµ·å§‹ä½ç½®: (8å­—èŠ‚)                              â”‚
â”‚ - ä¿ç•™: (44å­—èŠ‚)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¡¨1æ•°æ®åŒº (æ¯æ¡è®°å½•128å­—èŠ‚å›ºå®šé•¿åº¦)                 â”‚
â”‚ [è®°å½•1][è®°å½•2][è®°å½•3]...                             â”‚
â”‚ [Id(4B)][Deleted(1B)][Data(123B)]                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¡¨2æ•°æ®åŒº                                            â”‚
â”‚ ...                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è®°å½•ç»“æ„ç¤ºä¾‹
```csharp
// User è¡¨ï¼šåŒ…å«æ”¯æŒçš„æ‰€æœ‰ç±»å‹
// ç»“æ„: [Id(4B)] [IsDeleted(1B)] [Name(50B)] [Email(100B)] [CreatedAt(8B)] [Balance(16B)] [Padding(77B)]
// æ€»è®¡: 1 + 4 + 50 + 100 + 8 + 16 + 77 = 256 å­—èŠ‚

public class User
{
    public int Id { get; set; }                      // 4å­—èŠ‚
    
    [MaxLength(50)]
    public string Name { get; set; }                 // 50å­—èŠ‚ (UTF-8)
    
    [MaxLength(100)]
    public string Email { get; set; }                // 100å­—èŠ‚ (UTF-8)
    
    public DateTime CreatedAt { get; set; }          // 8å­—èŠ‚ (UTC Ticks)
    
    public decimal Balance { get; set; }             // 16å­—èŠ‚
    
    // IsDeleted: 1å­—èŠ‚ (ç”±æ¡†æ¶ç®¡ç†)
    // Padding: 77å­—èŠ‚ (ç”¨äºæœªæ¥æ‰©å±•)
}
```

#### æ ¸å¿ƒä¼˜åŠ¿
- **O(1) å¯»å€**ï¼š`offset = tableStartPos + (recordId - 1) * recordSize`
- **ç›´æ¥è¦†å†™**ï¼šä¿®æ”¹ä»»æ„å­—æ®µï¼Œåªéœ€å®šä½å¹¶è¦†å†™è¯¥è®°å½•ï¼Œæ— çº§è”ä½ç§»
- **å¿«é€Ÿåˆ é™¤**ï¼šåªéœ€è®¾ç½® `IsDeleted` æ ‡è®°ä½ï¼Œæ— éœ€é‡å†™æ•´ä¸ªæ–‡ä»¶
- **é¢„çŸ¥æ–‡ä»¶å¤§å°**ï¼šæ”¯æŒæ–‡ä»¶é¢„åˆ†é…ï¼Œé¿å…åŠ¨æ€æ‰©å±•ç¢ç‰‡

---

## 4.2.1 æ”¯æŒçš„æ•°æ®ç±»å‹çº¦å®š

æœ¬æ¡†æ¶ä»…æ”¯æŒä»¥ä¸‹å››ç§æ•°æ®ç±»å‹ï¼š

| ç±»å‹ | å­—èŠ‚æ•° | è¯´æ˜ |
|------|--------|------|
| **int** | 4 | 32ä½æœ‰ç¬¦å·æ•´æ•°ï¼Œä½¿ç”¨å°ç«¯å­—èŠ‚åº |
| **int?** | 5 | å¯ç©º intï¼ˆ1å­—èŠ‚æ ‡è®° + 4å­—èŠ‚æ•°æ®ï¼‰ |
| **bool** | 1 | å¸ƒå°”å€¼ï¼ˆ0x00=false, 0x01=trueï¼‰ |
| **bool?** | 2 | å¯ç©º boolï¼ˆ1å­—èŠ‚æ ‡è®° + 1å­—èŠ‚æ•°æ®ï¼‰ |
| **string** | å¯å˜ | UTF-8 ç¼–ç ï¼Œç”± `[MaxLength]` æ ‡æ³¨æœ€å¤§å­—èŠ‚æ•°ï¼Œé»˜è®¤ 1024 |
| **decimal** | 16 | .NET decimal ç±»å‹ï¼Œç”¨äºé‡‘èè®¡ç®— |
| **decimal?** | 17 | å¯ç©º decimalï¼ˆ1å­—èŠ‚æ ‡è®° + 16å­—èŠ‚æ•°æ®ï¼‰ |
| **DateTime** | 8 | UTC æ—¶é—´æˆ³ï¼Œå­˜å‚¨ä¸º Ticksï¼ˆåˆ»åº¦æ•°ï¼‰ |
| **DateTime?** | 9 | å¯ç©º DateTimeï¼ˆ1å­—èŠ‚æ ‡è®° + 8å­—èŠ‚æ•°æ®ï¼‰ |

#### å­—ç¬¦ä¸²é•¿åº¦çº¦å®š

- æ¯ä¸ª string å­—æ®µ**å¿…é¡»é€šè¿‡ `[MaxLength]` æ ‡æ³¨æœ€å¤§å­—èŠ‚æ•°**
- æœªæ ‡æ³¨ `[MaxLength]` çš„ string å­—æ®µå°†ä½¿ç”¨**é»˜è®¤å€¼ 1024 å­—èŠ‚**
- å­—ç¬¦ä¸²é‡‡ç”¨ **UTF-8 ç¼–ç **ï¼Œå¤šå­—èŠ‚å­—ç¬¦ï¼ˆå¦‚ä¸­æ–‡ï¼‰ä¼šæ¶ˆè€—å¤šä¸ªå­—èŠ‚
  - ASCII å­—ç¬¦ï¼š1 å­—èŠ‚
  - ä¸­æ–‡å­—ç¬¦ï¼šé€šå¸¸ 3 å­—èŠ‚
  - è¡¨æƒ…ç¬¦å·ï¼šé€šå¸¸ 4 å­—èŠ‚
- è¶…é•¿å­—ç¬¦ä¸²åœ¨ç¼–ç æ—¶**è‡ªåŠ¨æˆªæ–­**åˆ° MaxLength é™åˆ¶
- å­—ç¬¦ä¸²åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ä»¥ `0x00` ä½œä¸ºç»“å°¾æ ‡è®°

#### ç±»å‹é™åˆ¶åŸå› 

ä¸ºäº†å®ç°å¿«é€Ÿå¢é‡æ›´æ–°å’Œå›ºå®šé•¿åº¦äºŒè¿›åˆ¶å­˜å‚¨ï¼š

- âœ… åŸºæœ¬ç±»å‹ `int` / `bool` / `decimal` / `DateTime` å¤§å°å›ºå®šï¼Œç›´æ¥è®¡ç®—ä½ç½®
- âœ… å¯ç©ºç±»å‹ `int?` / `bool?` / `decimal?` / `DateTime?` é¢å¤–1å­—èŠ‚æ ‡è®°
- âœ… `string` é€šè¿‡ `[MaxLength]` çº¦æŸï¼Œå¯é¢„çŸ¥ç©ºé—´
- âŒ ä¸æ”¯æŒ `long`, `double`, `float` ç­‰å…¶ä»–æ•°å€¼ç±»å‹
- âŒ ä¸æ”¯æŒ `List<T>`, `object`, `Dictionary<K,V>` ç­‰å¤æ‚ç±»å‹
- âŒ ä¸æ”¯æŒ `byte?`, `short?` ç­‰å…¶ä»–å¯ç©ºç±»å‹

#### ä¸ºä»€ä¹ˆå¯ç©ºç±»å‹éœ€è¦é¢å¤– 1 å­—èŠ‚æ ‡è®°ï¼Ÿ
- ä¸å¢åŠ æ ‡è®°ä½æ—¶ï¼Œæ— æ³•åŒºåˆ†â€œç©ºå€¼â€å’Œâ€œé»˜è®¤å€¼â€ï¼ˆä¾‹å¦‚ `int` çš„ 0ã€`DateTime` çš„ ticks=0ï¼‰ã€‚
- ä½¿ç”¨å“¨å…µå€¼ä¼šæ±¡æŸ“ä¸šåŠ¡å«ä¹‰ï¼Œä¸”å„ç±»å‹å“¨å…µä¸ç»Ÿä¸€ï¼Œåç»­æ‰©å±•æ€§å·®ã€‚
- é¢å¤– 1 å­—èŠ‚æ ‡è®°ä½ä¿è¯è§£ç æ—¶ O(1) åˆ¤ç©ºï¼Œé¿å…å…¨è¡¨æ‰«ææˆ–é¢å¤–å…ƒæ•°æ®ã€‚

#### ç¤ºä¾‹

```csharp
public class Product
{
    public int Id { get; set; }                    // âœ… int
    
    [MaxLength(100)]
    public string Name { get; set; }               // âœ… string with [MaxLength]
    
    [MaxLength(500)]
    public string Description { get; set; }        // âœ… string with [MaxLength]
    
    public decimal Price { get; set; }             // âœ… decimal
    
    public DateTime CreatedAt { get; set; }        // âœ… DateTime (stored as UTC)
    
    public bool IsActive { get; set; }             // âœ… bool
    
    public int? CategoryId { get; set; }           // âœ… nullable int
    
    public DateTime? PublishedAt { get; set; }     // âœ… nullable DateTime
    
    // public long Count { get; set; }             // âŒ ä¸æ”¯æŒ
    // public double Rating { get; set; }          // âŒ ä¸æ”¯æŒ
    // public string[] Tags { get; set; }          // âŒ ä¸æ”¯æŒ
}
```

---

### 4.2 MicroDbContext ä½¿ç”¨æ–¹å¼
ç”¨æˆ·ç›´æ¥ï¼š
```csharp
var db = new MicroDbContext("data.mdb");

db.Users.Add(new User { Id = 1, Name = "Alice" });
db.SaveChanges(); // å¢é‡å†™å…¥

var adults = db.Users.Where(u => u.Age >= 18).ToList();
```

#### MicroDbContextèŒè´£ï¼š
- ç®¡ç†æ‰€æœ‰ `DbSet` è¡¨é›†åˆã€‚
- è´Ÿè´£æ•°æ®åº“åˆå§‹åŒ– & åŠ è½½æ•°æ®ã€‚
- è·Ÿè¸ªå®ä½“å¯¹è±¡çš„å¢åˆ æ”¹ï¼ˆChangeTrackerï¼‰ã€‚
- ä¿è¯è¯»å†™çº¿ç¨‹å®‰å…¨ã€‚
- è°ƒç”¨ StorageManager æ‰§è¡Œå¢é‡æ–‡ä»¶æ›´æ–°ã€‚

---

### 4.3 DbSet<TEntity>
- å†…å­˜é›†åˆçš„æ“ä½œæ¥å£ï¼š
  - `Add(TEntity entity)` â†’ æ ‡è®°ä¸ºæ–°å¢
  - `Remove(TEntity entity)` â†’ æ ‡è®°ä¸ºåˆ é™¤
  - `Update(TEntity entity)` â†’ æ ‡è®°ä¸ºä¿®æ”¹
- LINQæŸ¥è¯¢ç›´æ¥éå†å†…å­˜é›†åˆã€‚
- `IEnumerable<TEntity>` æä¾›æ ‡å‡†é›†åˆåŠŸèƒ½ã€‚
- æ‰€æœ‰æ”¹åŠ¨ç”±ChangeTrackerè®°å½•ï¼Œç”¨äºå¢é‡å†™å…¥ã€‚

---

### 4.4 ChangeTrackerï¼ˆå¢é‡å˜æ›´è·Ÿè¸ªï¼‰
æ•°æ®ç»“æ„ï¼š
```csharp
class ChangeTracker
{
    public List<object> Added { get; }
    public List<object> Modified { get; }
    public List<object> Deleted { get; }

    public void Clear();
}
```
- ä¿å­˜æœªæäº¤çš„å˜æ›´ã€‚
- SaveChangesï¼š
  1. è¿›å…¥å†™é”ã€‚
  2. åºåˆ—åŒ–å¹¶å†™å…¥ä»…å˜æ›´çš„è®°å½•ï¼ˆå¢é‡æ›´æ–°ï¼‰ã€‚
  3. æˆåŠŸåæ¸…ç©ºè®°å½•ã€‚
  4. å¤±è´¥åˆ™å›æ»šï¼ˆé‡æ–°åŠ è½½æ–‡ä»¶ä¸­çš„æ—§å€¼ï¼‰ã€‚

---

### 4.5 å¢é‡æ›´æ–°æœºåˆ¶
- æ¯æ¡è®°å½•åœ¨æ–‡ä»¶ä¸­æœ‰å”¯ä¸€ ID å’Œç‰©ç†åç§»åœ°å€ã€‚
- ä¿®æ”¹/åˆ é™¤æ—¶ï¼š
  - æ ¹æ® ID å®šä½æ–‡ä»¶çš„åç§»ä½ç½®ã€‚
  - è¦†å†™å¯¹åº”è®°å½•æ•°æ®ï¼ˆå›ºå®šé•¿åº¦äºŒè¿›åˆ¶ç¼–ç ï¼‰ã€‚
  - åˆ é™¤è®°å½•å¯åœ¨æ–‡ä»¶ä¸­æ ‡è®°ä¸º"æ— æ•ˆ"ï¼ˆIsDeleted=1ï¼‰ï¼Œç­‰å¾…å‹ç¼©ã€‚
- æ–°å¢è®°å½•ç›´æ¥è¿½åŠ åˆ°è¯¥è¡¨åŒºåŸŸæœ«å°¾ã€‚

è¿™æ ·é¿å…æ¯æ¬¡ä¿å­˜éƒ½é‡æ–°åºåˆ—åŒ–å…¨æ–‡ä»¶ã€‚

---

### 4.6 çº¿ç¨‹å®‰å…¨è®¾è®¡
- è¯»å†™åˆ†ç¦»é”ï¼ˆReaderWriterLockSlimï¼‰ï¼š
  - å¤šçº¿ç¨‹å¯å¹¶å‘è¯»å†…å­˜é›†åˆã€‚
  - æ–‡ä»¶å†™å…¥ç”±å•çº¿ç¨‹æ‰§è¡Œï¼Œé˜»å¡å…¶ä»–è¯»å†™ã€‚
- å†…å­˜å¯¹è±¡é›†åˆçš„å˜æ›´ä¹Ÿåœ¨å†™é”æ§åˆ¶ä¸‹è¿›è¡Œã€‚

---

### 4.7 åºåˆ—åŒ–ä¸å­—æ®µæ˜ å°„

#### æ”¯æŒçš„æ•°æ®ç±»å‹

| ç±»å‹ | å›ºå®šå¤§å° | ç¼–ç è§„åˆ™ |
|------|--------|--------|
| `int` | 4 å­—èŠ‚ | å°ç«¯å­—èŠ‚åºï¼ˆBitConverterï¼‰ |
| `int?` | 5 å­—èŠ‚ | 1å­—èŠ‚ null æ ‡è®° + 4å­—èŠ‚å€¼ |
| `bool` | 1 å­—èŠ‚ | 0x00=false, 0x01=true |
| `bool?` | 2 å­—èŠ‚ | 1å­—èŠ‚ null æ ‡è®° + 1å­—èŠ‚å€¼ |
| `string` | å¯å˜* | UTF-8 ç¼–ç ï¼Œç”± `[MaxLength]` æŒ‡å®šï¼Œé»˜è®¤ 1024 å­—èŠ‚ |
| `decimal` | 16 å­—èŠ‚ | .NET decimal äºŒè¿›åˆ¶æ ¼å¼ |
| `decimal?` | 17 å­—èŠ‚ | 1å­—èŠ‚ null æ ‡è®° + 16å­—èŠ‚å€¼ |
| `DateTime` | 8 å­—èŠ‚ | UTC æ—¶é—´æˆ³ï¼ŒTicks æ ¼å¼ |
| `DateTime?` | 9 å­—èŠ‚ | 1å­—èŠ‚ null æ ‡è®° + 8å­—èŠ‚å€¼ |

*`string` çš„å®é™…å ç”¨å­—èŠ‚æ•°ç”±å¼€å‘è€…é€šè¿‡ `[MaxLength]` å±æ€§æŒ‡å®šï¼ŒæœªæŒ‡å®šæ—¶é»˜è®¤ 1024 å­—èŠ‚ã€‚è¶…å‡ºé•¿åº¦çš„å­—ç¬¦ä¸²åœ¨ç¼–ç æ—¶è‡ªåŠ¨æˆªæ–­ã€‚

#### å­—æ®µæ˜ å°„ä¸å¤§å°è®¡ç®—

```csharp
// å­—æ®µç±»å‹ â†’ äºŒè¿›åˆ¶å¤§å°æ˜ å°„
public static class FieldSizeCalculator
{
    public static int GetFixedSize(PropertyInfo property)
    {
        var type = property.PropertyType;
        var underlyingType = Nullable.GetUnderlyingType(type) ?? type;
        bool isNullable = Nullable.GetUnderlyingType(type) != null;
        
        int baseSize = 0;
        if (underlyingType == typeof(int))
            baseSize = 4;
        else if (underlyingType == typeof(bool))
            baseSize = 1;
        else if (underlyingType == typeof(decimal))
            baseSize = 16;
        else if (underlyingType == typeof(DateTime))
            baseSize = 8;
        else if (underlyingType == typeof(string))
        {
            // ä» [MaxLength] ç‰¹æ€§è¯»å–ï¼Œé»˜è®¤ 1024
            var maxLengthAttr = property.GetCustomAttribute<MaxLengthAttribute>();
            return maxLengthAttr?.Length ?? 1024;  // å­—ç¬¦ä¸²ä¸æ”¯æŒå¯ç©º
        }
        else
            throw new NotSupportedException($"Type {type.Name} is not supported");
        
        // å¯ç©ºç±»å‹é¢å¤–éœ€è¦ 1 å­—èŠ‚æ ‡è®°
        return isNullable ? baseSize + 1 : baseSize;
    }
}
```

#### ä½¿ç”¨ç¤ºä¾‹ï¼ˆå¸¦å­—ç¬¦ä¸²é•¿åº¦æŒ‡å®šï¼‰

```csharp
public class User
{
    public int Id { get; set; }                      // 4 å­—èŠ‚
    
    [MaxLength(50)]  // æŒ‡å®šå­—ç¬¦ä¸²æœ€å¤§å­—èŠ‚æ•°ï¼ˆUTF-8ç¼–ç ï¼‰
    public string Name { get; set; }                 // 50 å­—èŠ‚
    
    [MaxLength(100)]
    public string Email { get; set; }                // 100 å­—èŠ‚
    
    public DateTime CreatedAt { get; set; }          // 8 å­—èŠ‚ï¼ˆUTCï¼‰
    
    public decimal Balance { get; set; }             // 16 å­—èŠ‚
    
    public bool IsActive { get; set; }               // 1 å­—èŠ‚
    
    public int? CategoryId { get; set; }             // 5 å­—èŠ‚ï¼ˆ1æ ‡è®°+4å€¼ï¼‰
    
    public DateTime? PublishedAt { get; set; }       // 9 å­—èŠ‚ï¼ˆ1æ ‡è®°+8å€¼ï¼‰
    
    // æ€»è®¡: 4 + 50 + 100 + 8 + 16 + 1 + 5 + 9 = 193 å­—èŠ‚/è®°å½•
    // å†åŠ  IsDeleted(1å­—èŠ‚) + Padding(62å­—èŠ‚) = 256 å­—èŠ‚ï¼ˆå¯¹é½ï¼‰
}

// å¯ç©ºç±»å‹ç¤ºä¾‹
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; }                 // é»˜è®¤ 1024 å­—èŠ‚
    public decimal? Price { get; set; }              // å¯ç©º decimal
    public bool? IsPublished { get; set; }           // å¯ç©º bool
    public DateTime? LastModified { get; set; }      // å¯ç©º DateTime
}
```

#### å†…éƒ¨ç¼–è§£ç æµç¨‹

```csharp
// åºåˆ—åŒ–ï¼ˆå†™å…¥æ–‡ä»¶ï¼‰
public byte[] SerializeRecord(object entity)
{
    var buffer = new byte[recordSize];
    int offset = 0;
    
    // è·³è¿‡ IsDeleted æ ‡è®°ä½ï¼ˆç”± StorageManager ç®¡ç†ï¼‰
    offset += 1;
    
    foreach (var prop in entityType.GetProperties())
    {
        var value = prop.GetValue(entity);
        int fieldSize = FieldSizeCalculator.GetFixedSize(prop);
        WriteField(buffer, offset, value, prop.PropertyType, fieldSize);
        offset += fieldSize;
    }
    
    return buffer;
}

// ååºåˆ—åŒ–ï¼ˆè¯»å–å†…å­˜ï¼‰
public T DeserializeRecord(byte[] buffer)
{
    var entity = Activator.CreateInstance<T>();
    int offset = 1; // è·³è¿‡ IsDeleted
    
    foreach (var prop in entityType.GetProperties())
    {
        int fieldSize = FieldSizeCalculator.GetFixedSize(prop);
        var value = ReadField(buffer, offset, prop.PropertyType, fieldSize);
        prop.SetValue(entity, value);
        offset += fieldSize;
    }
    
    return entity;
}

// å­—æ®µå†™å…¥ï¼ˆæ”¯æŒçš„ç±»å‹ï¼‰
private void WriteField(byte[] buffer, int offset, object value, Type type, int size)
{
    var underlyingType = Nullable.GetUnderlyingType(type) ?? type;
    bool isNullable = Nullable.GetUnderlyingType(type) != null;
    bool isNull = value == null;
    
    if (isNullable)
    {
        // å¯ç©ºç±»å‹ï¼šç¬¬ä¸€å­—èŠ‚ä¸ºæ ‡è®°ä½
        buffer[offset] = isNull ? (byte)1 : (byte)0;
        offset += 1;
    }
    
    if (isNull)
        return;  // null å€¼åªå†™æ ‡è®°ä½
    
    if (underlyingType == typeof(string))
    {
        var str = (string)value ?? "";
        var bytes = Encoding.UTF8.GetBytes(str);
        // å°†å­—ç¬¦ä¸²å†™å…¥å›ºå®šé•¿åº¦åŒºåŸŸ
        Array.Copy(bytes, 0, buffer, offset, Math.Min(bytes.Length, size));
        // å‰©ä½™ä½ç½®è‡ªåŠ¨å¡«å…… 0x00ï¼ˆå­—ç¬¦ä¸²ç»“å°¾æ ‡è®°ï¼‰
    }
    else if (underlyingType == typeof(int))
    {
        BitConverter.GetBytes((int)value).CopyTo(buffer, offset);
    }
    else if (underlyingType == typeof(bool))
    {
        buffer[offset] = (bool)value ? (byte)1 : (byte)0;
    }
    else if (underlyingType == typeof(decimal))
    {
        var bits = decimal.GetBits((decimal)value);
        for (int i = 0; i < 4; i++)
        {
            BitConverter.GetBytes(bits[i]).CopyTo(buffer, offset + i * 4);
        }
    }
    else if (underlyingType == typeof(DateTime))
    {
        // ä»…æ”¯æŒ UTC æ—¶é—´
        var utcTime = ((DateTime)value).ToUniversalTime();
        BitConverter.GetBytes(utcTime.Ticks).CopyTo(buffer, offset);
    }
}

// å­—æ®µè¯»å–
private object ReadField(byte[] buffer, int offset, Type type, int size)
{
    var underlyingType = Nullable.GetUnderlyingType(type) ?? type;
    bool isNullable = Nullable.GetUnderlyingType(type) != null;
    
    if (isNullable)
    {
        // å¯ç©ºç±»å‹ï¼šç¬¬ä¸€å­—èŠ‚ä¸ºæ ‡è®°ä½
        bool isNull = buffer[offset] == 1;
        offset += 1;
        if (isNull)
            return null;  // è¿”å› null
    }
    
    if (underlyingType == typeof(string))
    {
        // æŸ¥æ‰¾ 0x00 ç»“å°¾æˆ–è¯»å–åˆ° size å­—èŠ‚
        int length = 0;
        for (int i = 0; i < size && buffer[offset + i] != 0; i++)
            length++;
        return Encoding.UTF8.GetString(buffer, offset, length);
    }
    else if (underlyingType == typeof(int))
    {
        return BitConverter.ToInt32(buffer, offset);
    }
    else if (underlyingType == typeof(bool))
    {
        return buffer[offset] != 0;
    }
    else if (underlyingType == typeof(decimal))
    {
        int[] bits = new int[4];
        for (int i = 0; i < 4; i++)
            bits[i] = BitConverter.ToInt32(buffer, offset + i * 4);
        return new decimal(bits);
    }
    else if (underlyingType == typeof(DateTime))
    {
        long ticks = BitConverter.ToInt64(buffer, offset);
        return new DateTime(ticks, DateTimeKind.Utc);
    }
    
    return null;
}
```

#### ä¼˜ç‚¹
- **å®Œå…¨è‡ªä¸»å®ç°**ï¼šä¸ä¾èµ–é¢å¤–åºåˆ—åŒ–åº“
- **å¯åŠ¨å¿«é€Ÿ**ï¼šæ— åå°„å¼€é”€ï¼ˆå¯åœ¨å¯åŠ¨æ—¶ç¼“å­˜å­—æ®µæ˜ å°„ï¼‰
- **å†…å­˜é«˜æ•ˆ**ï¼šå›ºå®šå¤§å°ï¼Œæ˜“äºé¢„åˆ†é…
- **å¢é‡æ›´æ–°ç›´æ¥**ï¼šä¿®æ”¹ä¸€ä¸ªå­—æ®µï¼Œä»…è¦†å†™è¯¥å­—æ®µå¯¹åº”çš„å­—èŠ‚èŒƒå›´
- **å­—ç¬¦ä¸²çµæ´»**ï¼šæ”¯æŒå˜é•¿å­—ç¬¦ä¸²ï¼Œé€šè¿‡ `[MaxLength]` æŒ‡å®šä¸Šé™

---

## 5. API è®¾è®¡ç¤ºä¾‹
```csharp
// å®ä½“æ¨¡å‹ï¼ˆç”¨æˆ·æ— éœ€ä»»ä½•åºåˆ—åŒ–ç‰¹æ€§ï¼‰
public class User
{
    public int Id { get; set; }
    
    [MaxLength(50)]
    public string Name { get; set; }
    
    public int Age { get; set; }
    
    public decimal Balance { get; set; }
    
    public DateTime CreatedAt { get; set; }
}

// ä½¿ç”¨
var ctx = new MicroDbContext("data.mdb");
ctx.Users.Add(new User 
{ 
    Id = 1, 
    Name = "Alice", 
    Balance = 1000m,
    CreatedAt = DateTime.UtcNow,
    IsActive = true,
    CategoryId = 5,
    PublishedAt = DateTime.UtcNow
});
ctx.SaveChanges();

var activeUsers = ctx.Users.Where(u => u.IsActive && u.Balance >= 500).ToList();
```

---

## 6. æ€§èƒ½ä¼˜åŒ–æ–¹å‘

1. å¢é‡å†™å…¥
   - åªæ›´æ–°æ–‡ä»¶ä¸­å˜æ›´çš„è®°å½•ï¼Œé™ä½ç£ç›˜ IOã€‚
   - åˆ é™¤è®°å½•åªåšæ ‡è®°ï¼Œå®šæœŸå‹ç¼©æ–‡ä»¶ä»¥å›æ”¶ç©ºé—´ã€‚

2. å†…å­˜ç¼“å­˜ä¼˜åŒ–
   - å¯åŠ¨åå…¨æ•°æ®åŠ è½½åˆ°å†…å­˜ã€‚
   - é¢‘ç¹è®¿é—®è®°å½•å¯ç”¨ `Dictionary<Id, Entity>` æé«˜æŸ¥æ‰¾é€Ÿåº¦ã€‚

3. åºåˆ—åŒ–ä¼˜åŒ–
   - é‡‡ç”¨å›ºå®šé•¿åº¦äºŒè¿›åˆ¶ç¼–ç ï¼Œé¿å…å˜é•¿ç¼–ç å¯¼è‡´çš„ä½ç½®åç§»ã€‚
   - å¯åŠ¨æ—¶ç”Ÿæˆå­—æ®µæ˜ å°„è¡¨ï¼Œåç»­ç¼–è§£ç é›¶åå°„å¼€é”€ã€‚
   - å­—ç¬¦ä¸²å­—æ®µä½¿ç”¨ UTF-8ï¼Œè¶…é•¿éƒ¨åˆ†è‡ªåŠ¨æˆªæ–­ï¼ˆé˜²æ­¢ç¼“å†²åŒºæº¢å‡ºï¼‰ã€‚

4. å¹¶å‘è¯»å–ä¼˜åŒ–
   - ReaderWriterLockSlim æä¾›é«˜æ•ˆè¯»é”ï¼Œå‡å°‘é”å†²çªã€‚
   - æŸ¥è¯¢å…¨éƒ¨æ‰§è¡Œåœ¨å†…å­˜é›†åˆä¸­ã€‚

5. å‹ç¼©/æ•´ç†æœºåˆ¶ï¼ˆåå°ä»»åŠ¡ï¼‰
   - ç›‘æ§æ–‡ä»¶å¤§å°ä¸å·²åˆ é™¤è®°å½•ï¼ˆIsDeleted=1ï¼‰æ¯”ä¾‹ã€‚
   - è¾¾åˆ°é˜ˆå€¼ï¼ˆå¦‚ 30% ç¢ç‰‡ç‡ï¼‰æ—¶æ‰§è¡Œæ–‡ä»¶å‹ç¼©ï¼š
     1. åˆ›å»ºä¸´æ—¶æ–‡ä»¶
     2. é€æ¡æ‰«æåŸæ–‡ä»¶ï¼Œè·³è¿‡å·²åˆ é™¤è®°å½•
     3. å†™å…¥æ–°æ–‡ä»¶å¹¶æ›´æ–°å…ƒæ•°æ®
     4. åŸå­æ›¿æ¢ï¼ˆrenameï¼‰å®Œæˆå‹ç¼©

6. å¼‚æ­¥æ–‡ä»¶å†™å…¥ï¼ˆå¯é€‰ï¼‰
   - SaveChanges åœ¨åå°æ‰§è¡Œï¼Œæå‡ä¸»çº¿ç¨‹å“åº”é€Ÿåº¦ã€‚
   - åœ¨ä¸‹æ¬¡æŸ¥è¯¢å‰ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

---

## 7. å¼€å‘é˜¶æ®µè®¡åˆ’

é˜¶æ®µ 1ï¼ˆæ ¸å¿ƒå¯ç”¨ç‰ˆï¼‰
- MicroDbContextï¼ˆåˆå§‹åŒ–/åŠ è½½/SaveChangesï¼‰
- DbSet<TEntity>
- ChangeTrackerï¼ˆå¢é‡è®°å½•ï¼‰
- ReaderWriterLockSlimï¼ˆå¹¶å‘æ§åˆ¶ï¼‰
- StorageManagerï¼ˆå›ºå®šé•¿åº¦äºŒè¿›åˆ¶ç¼–è§£ç ã€å¢é‡å†™å…¥ï¼‰

é˜¶æ®µ 2ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
- å­—æ®µæ˜ å°„ç¼“å­˜ï¼ˆå¯åŠ¨æ—¶ç”Ÿæˆï¼Œå‡å°‘åå°„ï¼‰
- å†…å­˜ç´¢å¼•ï¼ˆDictionary Id â†’ Entityï¼‰
- å¼‚æ­¥ SaveChangesï¼ˆåå°çº¿ç¨‹æŒä¹…åŒ–ï¼‰
- æ–‡ä»¶å‹ç¼©å·¥å…·

é˜¶æ®µ 3ï¼ˆæ‰©å±•ç‰ˆï¼‰
- è¡¨ç»“æ„è‡ªåŠ¨æ³¨å†Œï¼ˆå®ä½“æ‰«æï¼‰
- è·¨å¹³å°æ•°æ®åŒæ­¥ï¼ˆé€‰åšï¼‰
- EF Core Provider æ¥å…¥ï¼ˆé€‰åšï¼‰

---

### âœ… ç»“è®º
è¿™ä¸ªç‰ˆæœ¬çš„æ–‡æ¡£å·²ç»ï¼š
- å›ºå®šé•¿åº¦äºŒè¿›åˆ¶å­˜å‚¨ï¼Œå®ç° O(1) å¯»å€çš„å¢é‡æ›´æ–°
- æ˜ç¡®æ”¯æŒçš„æ•°æ®ç±»å‹ï¼š**intã€boolã€stringã€decimalã€DateTime(UTC) åŠå…¶å¯ç©ºç‰ˆæœ¬**
    - åŸºæœ¬ç±»å‹ï¼šint(4B)ã€bool(1B)ã€decimal(16B)ã€DateTime(8B)
    - å¯ç©ºç‰ˆæœ¬ï¼šint?(5B)ã€bool?(2B)ã€decimal?(17B)ã€DateTime?(9B)ï¼ˆé¢å¤– 1B æ ‡è®°ä½ï¼‰
    - string é€šè¿‡ `[MaxLength]` æ ‡æ³¨æœ€å¤§å­—èŠ‚æ•°ï¼Œé»˜è®¤ 1024ï¼Œä»…æ”¯æŒ UTF-8ï¼›string ä¸æ”¯æŒå¯ç©ºï¼ˆä½¿ç”¨ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºï¼‰
- æ˜ç¡®äº†å¯ç©ºç±»å‹éœ€è¦é¢å¤–æ ‡è®°ä½çš„åŸå› ï¼Œé¿å…é»˜è®¤å€¼ä¸ç©ºå€¼æ··æ·†
- ç¡®å®šçº¿ç¨‹å®‰å…¨ç­–ç•¥ï¼ˆå¤šçº¿ç¨‹è¯» / å•çº¿ç¨‹æ–‡ä»¶å†™ï¼‰
- æä¾›å­—æ®µæ˜ å°„ã€ç¼–è§£ç çš„å…·ä½“å®ç°ç¤ºä¾‹ï¼ˆå«å¯ç©ºå¤„ç†ï¼‰

---

## é™„å½•ï¼šå®ç°å‚è€ƒä»£ç ç‰‡æ®µ

### æ–‡ä»¶æ“ä½œæ ¸å¿ƒï¼ˆStorageManagerï¼‰
```csharp
public class StorageManager
{
    private const int FILE_HEADER_SIZE = 256;
    private const int TABLE_META_SIZE = 128;
    
    // ç›´æ¥è¦†å†™å•æ¡è®°å½•
    public void UpdateRecord(string tableName, int recordId, byte[] data)
    {
        var table = GetTableMetadata(tableName);
        // è®¡ç®—ä½ç½®ï¼šO(1) å¯»å€
        long offset = table.DataStartOffset + (recordId - 1) * table.RecordSize;
        
        using (var file = new FileStream(_filePath, FileMode.Open, FileAccess.Write))
        {
            file.Seek(offset, SeekOrigin.Begin);
            file.Write(data, 0, data.Length);
        }
    }
    
    // æ ‡è®°åˆ é™¤ï¼ˆä¸é‡å†™æ•´ä¸ªæ–‡ä»¶ï¼‰
    public void DeleteRecord(string tableName, int recordId)
    {
        long offset = GetRecordOffset(tableName, recordId);
        
        using (var file = new FileStream(_filePath, FileMode.Open, FileAccess.Write))
        {
            file.Seek(offset, SeekOrigin.Begin);
            file.WriteByte(1);  // ä»…è®¾ç½® IsDeleted æ ‡è®°ä½
        }
    }
    
    // å‹ç¼©æ–‡ä»¶ï¼ˆåˆ é™¤æ ‡è®°ä¸ºå·²åˆ é™¤çš„è®°å½•ï¼‰
    public void CompactDatabase()
    {
        string tempPath = _filePath + ".tmp";
        
        using (var reader = new FileStream(_filePath, FileMode.Open, FileAccess.Read))
        using (var writer = new FileStream(tempPath, FileMode.Create, FileAccess.Write))
        {
            // å¤åˆ¶æ–‡ä»¶å¤´å’Œè¡¨å…ƒæ•°æ®
            byte[] header = new byte[FILE_HEADER_SIZE + (tableCount * TABLE_META_SIZE)];
            reader.Read(header, 0, header.Length);
            writer.Write(header, 0, header.Length);
            
            // é€è¡¨æ‰«æï¼Œè·³è¿‡å·²åˆ é™¤è®°å½•
            foreach (var table in Tables)
            {
                int activeRecords = 0;
                for (int i = 0; i < table.RecordCount; i++)
                {
                    byte[] record = new byte[table.RecordSize];
                    reader.Read(record, 0, table.RecordSize);
                    
                    // æ£€æŸ¥ IsDeleted æ ‡è®°
                    if (record[0] == 0)
                    {
                        writer.Write(record, 0, table.RecordSize);
                        activeRecords++;
                    }
                }
                
                // æ›´æ–°è¡¨çš„è®°å½•è®¡æ•°
                UpdateTableRecordCount(table.Name, activeRecords);
            }
        }
        
        // åŸå­æ›¿æ¢
        File.Delete(_filePath);
        File.Move(tempPath, _filePath);
    }
}
```

### å­—æ®µæ˜ å°„ç¤ºä¾‹
```csharp
public class EntityMetadata
{
    public Type EntityType { get; set; }
    public List<FieldMetadata> Fields { get; set; }
    public int RecordSize { get; set; }
    
    public static EntityMetadata Create<T>()
    {
        var properties = typeof(T).GetProperties();
        var fields = new List<FieldMetadata>();
        int offset = 1; // è·³è¿‡ IsDeleted
        
        foreach (var prop in properties)
        {
            int size = GetFieldSize(prop);
            fields.Add(new FieldMetadata 
            { 
                Property = prop, 
                Offset = offset, 
                Size = size 
            });
            offset += size;
        }
        
        return new EntityMetadata 
        { 
            EntityType = typeof(T),
            Fields = fields,
            RecordSize = offset
        };
    }
}
```

### ä½¿ç”¨ç¤ºä¾‹
```csharp
// ç”¨æˆ·ä»£ç 
var db = new MicroDbContext("app.mdb");

// æ·»åŠ è®°å½•ï¼ˆæ”¯æŒçš„æ‰€æœ‰ç±»å‹ï¼‰
var user = new User 
{ 
    Id = 1, 
    Name = "Alice",          // string (MaxLength: 50)
    Email = "alice@x.com",   // string (MaxLength: 100)
    CreatedAt = DateTime.UtcNow,  // DateTime (UTC)
    Balance = 1000m          // decimal
};
db.Users.Add(user);
db.SaveChanges();  // è¿½åŠ ä¸€æ¡ 256B è®°å½•åˆ°æ–‡ä»¶æœ«å°¾

// ä¿®æ”¹å­—æ®µ
user.Name = "Alexandra";
user.Balance = 1500m;
db.Users.Update(user);
db.SaveChanges();  // ä»…è¦†å†™ä¿®æ”¹çš„å­—æ®µåŒºåŸŸï¼ˆå­—ç¬¦ä¸²å’Œdecimalï¼‰ï¼Œå…¶ä»–ä¸åŠ¨

// åˆ é™¤è®°å½•
db.Users.Remove(user);
db.SaveChanges();  // ä»…è®¾ç½® IsDeleted ä½ä¸º 1ï¼Œæ¯«ç§’çº§å®Œæˆ

// æŸ¥è¯¢ï¼ˆåŸºäºå†…å­˜é›†åˆçš„ LINQï¼‰
var expensiveUsers = db.Users
    .Where(u => u.Balance >= 500 && u.Name.Contains("A"))
    .OrderByDescending(u => u.CreatedAt)
    .ToList();

// å‹ç¼©ï¼ˆå¯é€‰ï¼Œåœ¨åå°å®šæ—¶æ‰§è¡Œï¼‰
db.CompactDatabase();  // é‡å†™æ–‡ä»¶ï¼Œåˆ é™¤ IsDeleted=1 çš„è®°å½•ï¼Œå›æ”¶ç©ºé—´
```